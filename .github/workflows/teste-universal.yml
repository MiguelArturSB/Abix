name: Teste Universal do Abix

on: [push]

jobs:
  testar-sistemas:
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            pkg_target: node18-linux-x64
            bin_name: abix
            exec_cmd: ./abix
          - os: macos-latest
            pkg_target: node18-macos-x64
            bin_name: abix
            exec_cmd: ./abix
          - os: windows-latest
            pkg_target: node18-win-x64
            bin_name: abix.exe
            exec_cmd: ./abix.exe
    
    runs-on: ${{ matrix.os }}

    steps:
    - name: Baixar C√≥digo
      uses: actions/checkout@v3

    - name: Instalar Node para Build
      uses: actions/setup-node@v3
      with:
        node-version: 18
        cache: 'npm'

    - name: Instalar Depend√™ncias e PKG
      run: |
        npm install
        npm install -g pkg

    - name: üèóÔ∏è Gerar Execut√°vel Bin√°rio
      run: pkg src/cli.js --targets ${{ matrix.pkg_target }} --output ${{ matrix.bin_name }}

    # --- ETAPAS DE TESTE ATUALIZADAS ---
    - name: ‚öôÔ∏è Criar Configura√ß√£o do Projeto (For√ßado)
      # CORRE√á√ÉO: Adicionada a flag --force e a vers√£o correta do Python
      run: ${{ matrix.exec_cmd }} init node:20.11.0 python:3.11.3 --force

    - name: üöÄ Testar 1 (Download + Instala√ß√£o + Criar Snapshot)
      run: ${{ matrix.exec_cmd }} testar

    - name: üóëÔ∏è Limpar apenas Local
      run: ${{ matrix.exec_cmd }} clean

    - name: ‚ö° Testar 2 (Restaura√ß√£o via Snapshot)
      run: ${{ matrix.exec_cmd }} testar